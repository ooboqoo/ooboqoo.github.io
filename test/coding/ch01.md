# 可测试的 JavaScript

## 1.1 现有技术

### 1.1.1 敏捷开发

传统开发中的瀑布模型首先需要编写需求规范，然后程序员编码、测试人员测试、应用程序部署，最后再回头重新更新新的需求。该过程的每一步都是连续且独立的，当在进行其中一步时，其他步骤的相关人员都在等待。

敏捷开发尝试以更加灵活的方式让每个阶段都并行发生。使用敏捷开发方法并不一定意味着应用程序完成得更快且质量更高。敏捷开发的最大优势是它处理需求变更的方法。其基本思想是：快速迭代和持续交付可以加快高质量软件的交付。

#### 拥抱变化

任何软件类系统或项目，即使你前期花在需求上的时间足够长，你也很难在需求阶段真正的分析和挖掘出所有的需求。有些需求注定会在设计实现或用户使用过程中才逐渐出现。要承认软件开发中存在这种不确定性。而瀑布模型将这种识别变化延迟到最好的测试或用户使用阶段才发现，极大的增加了返工或变更成本。敏捷思想里面通过短周期迭代，尽可能早的交付可用的迭代版本来拥抱和适应变化。

#### 进度可视

任何一个软件项目，需求或设计做完我们并不清楚进度是否真正完成了60%或者更多，任何不是经过测试通过的功能我们都很难把握真正的完成进度情况。因此在敏捷里面换了一种思路，如讲这个项目拆分为100个粒度差不多的功能点，如果有60个功能点全部完成并通过验证和测试，我们就比较有把握说整体进度完成了60%。这种可视化的评估进度模式在瀑布里面较难以做到。

### 1.1.2 测试驱动开发 TDD

它要求在编写某个功能的代码之前先编写测试代码，然后只编写使测试通过的功能代码，通过测试来推动整个开发的进行。这有助于编写简洁可用和高质量的代码，并加速开发过程。

在新建项目或模块时，使用 TDD 的效果显然是最好的，如果只是需要单元测试，那它也是最成功的。在现实中，往往开始时，开发人员会沿着这条路走，但很快功能代码就会超过测试代码（理论是理论，实际做起来很难实现）。

### 1.1.3 行为驱动开发 BDD

行为驱动开发 BDD 是在 TDD 基础上发展而来的。行为驱动开发的根基是一种“通用语言”。这种通用语言同时被客户和开发者用来定义系统的行为。由于客户和开发者使用同一种“语言”来描述同一个系统，可以最大程度避免表达不一致带来的问题。

### 1.1.4 哪种方式最好

瀑布、螺旋、敏捷 以及其他方法都很好用，但都没有产生可测试的代码。同样 TDD、BDD 以及其他形式的开发方式也不一定确保有可测试的 JavaScript。

**确保编写出整洁、松耦合并有足够注释，且确保别人能够接手维护的代码，才是真正可测试的代码。**

## 1.2 代码是让人用的

尼古拉斯说：“当你开始工作时，你不是在给你自己写代码，而是为后来人写代码。”

### 1.2.1 为何要编写可测试的代码

可测试、可维护和可理解是相互关联的，在 **可测试、可维护、可理解** 的代码上发现并修复 bug 会简单得多。

若果代码不能被后面维护的人理解，那么，通常代码会被全部重写，也就是说，无法测试、维护、理解的代码就是一堆垃圾。

### 1.2.2 什么是可测试的代码

#### 什么是可测试性
一般来说，使代码易于测试的特性，同样使代码易于维护，以及更容易理解：**短小但也不太复杂的代码、完整的注释，以及松耦合**。

#### 什么是可维护性
可维护的代码可以存在于一个完整的产品生命周期：产品从一个人转到另外一个人手里是，不需要部分或全部重写。可以修复和更改代码，而不必完全理解所有的代码，对局部做的修改不会影响别的功能，这样的代码就是可维护的代码。

#### 什么是可理解性
可理解就是让他人能看懂你的代码。简单的、小型的且有注释的代码往往更加容易理解，通过单独运行来测试关于代码的假设，也能大大有助于理解。

### 1.2.3 如何编写可测试的代码

#### 如何编写可测试的代码
我相信编写可测试的代码，有必要不断地进行测试。在 TDD 和 BDD 之间，我要提出第三种方法：测试循环开发 test-while-driven。测试和代码是鸡生蛋和蛋生鸡的问题，在编写一段代码后，就开始编写一段测试；或者编写一段测试后，就开始编写一段代码。

在一点一点编写代码和测试的时候，记住要考虑到大局：**编写短小、最小依赖和最低复杂度的可隔离的代码块，这种思想是本书的精髓**。

#### 如何编写可理解的代码
代码越简单越容易理解，有测试的代码使我们能够进一步了解代码的意图和内部运作机理，注释可以提高可理解性。

编写代码类似于创作小说章节：多个小章节比几个大章节更容易理解。详尽的注释（方法前插入的注释块）和简明的代码（选择有意义的变量名、遵循最佳实践、遵循一致的编码风格，等等）可以提高可理解性。

## 1.3 卓越的应用程序代码

### 1.3.1 测试

单元测试是开发者的第一道防线。单元测试不仅能强迫开发人员理解我们的代码，也能帮助我们记录和调试代码。  
除了单元测试，集成测试有助于确保一切都能按预期集成在一起。  
最后，性能测试和负载测试有助于确保应用程序能够按指标执行。

### 1.3.2 调试

## 1.4 小结

编写可测试的代码会让我们的工作以及后续着的工作变得更加容易，从更少的 bug 到 更容易修复的 bug，编写可测试的代码是让我们保持清醒的方式。
