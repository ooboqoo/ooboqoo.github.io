<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/lib/html-main.css" />
<script src="/lib/html-main.js"></script>
<script>
function showHint(str) {
  var xmlhttp=new XMLHttpRequest();
  xmlhttp.open("GET","/gethint.php?q="+str,true);
  xmlhttp.send();
  xmlhttp.onreadystatechange=function() {
    if (xmlhttp.readyState==4 && xmlhttp.status==200)
      document.getElementById("txtHint").innerHTML=xmlhttp.responseText;
  }
}
</script>
<title>AJAX 教程</title>
</head>
<body>
<div id="article">

<h1>AJAX 简介</h1>

<div>
<h2>什么是 AJAX ？</h2>
<p>AJAX = Asynchronous JavaScript and XML（异步的 JavaScript 和 XML）。</p>
<p>AJAX 不是新的编程语言，而是一种使用现有标准的新方法。</p>
<p>AJAX 是与服务器交换数据并更新部分网页的艺术，在不重新加载整个页面的情况下。</p>
</div>

<div>
<h2>Google Suggest</h2>
<p>在 2005 年，Google 通过其 Google Suggest 使 AJAX 变得流行起来。</p>
<p>Google Suggest 使用 AJAX 创造出动态性极强的 web 界面：当您在谷歌的搜索框输入关键字时，JavaScript 会把这些字符发送到服务器，然后服务器会返回一个搜索建议的列表。</p>
</div>

<div>
<h2>完整AJAX示例</h2>
<pre>
function showHint(str) {
  var xmlhttp;
  if (window.XMLHttpRequest) xmlhttp=new <code>XMLHttpRequest()</code>;
  else xmlhttp=new <code>ActiveXObject("Microsoft.XMLHTTP")</code>;  <span>// code for IE6, IE5</span>
  xmlhttp.<code>open</code>("GET","gethint.php?q="+str,<code>true</code>);
  xmlhttp.<code>send</code>();
  xmlhttp.<code>onreadystatechange</code>=function() {
    if (xmlhttp.<code>readyState==4</code> &amp;&amp; xmlhttp.<code>status==200</code>)
      document.getElementById("txtHint").innerHTML=xmlhttp.<code>responseText</code>;
  }
}
</pre>
</div>

<h1>AJAX - 创建 XMLHttpRequest 对象</h1>

<div>
<h2>XMLHttpRequest 对象</h2>
<p>XMLHttpRequest 是 AJAX 的基础。</p>
<p>所有现代浏览器均支持 XMLHttpRequest 对象（IE5 和 IE6 使用 ActiveXObject）。</p>
<p>XMLHttpRequest 用于在后台与服务器交换数据。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。</p>
</div>

<div>
<h2>创建 XMLHttpRequest 对象</h2>
<pre>var xmlhttp;
if (window.XMLHttpRequest) {
  xmlhttp=new XMLHttpRequest();  <span>// code for IE7+, Firefox, Chrome, Opera, Safari</span>
}else {
  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");  <span>// code for IE6, IE5</span>
}
</pre>
</div>

<h1>AJAX - 向服务器发送请求</h1>

<div>
<h2>向服务器发送请求</h2>
<p>如需将请求发送到服务器，我们使用 XMLHttpRequest 对象的 open() 和 send() 方法：</p>
<pre>xmlhttp.open("GET","test1.txt",true);
xmlhttp.send();
</pre>
<table><tbody>
<tr><th>方法</th><th>描述</th></tr>
<tr><td>open(<i>method</i>,<i>url</i>,<i>async</i>)</td><td><p>规定请求的类型、URL 以及是否异步处理请求。</p>
	<ul><li><i>method</i>：请求的类型；GET 或 POST</li><li><i>url</i>：文件在服务器上的位置</li><li><i>async</i>：true（异步）或 false（同步）</li></ul></td></tr>
<tr><td>send(<i>string</i>)</td>
<td><p>将请求发送到服务器。</p><ul><li><i>string</i>：仅用于 POST 请求</li></ul></td></tr>
</tbody></table>
</div>

<div>
<h2>GET 还是 POST？</h2>
<p>与 POST 相比，GET 更简单也更快，并且在大部分情况下都能用。</p>
<p>然而，在以下情况中，请使用 POST 请求：</p>
<ul>
<li>无法使用缓存文件（更新服务器上的文件或数据库）</li>
<li>向服务器发送大量数据（POST 没有数据量限制）</li>
<li>发送包含未知字符的用户输入时，POST 比 GET 更稳定也更可靠</li>
</ul>
</div>

<div>
<h2>GET 请求</h2>
<p>如果您希望通过 GET 方法发送信息，请向 URL 添加信息：</p>
<pre>xmlhttp.open("GET","demo_get2.asp?fname=Bill&amp;lname=Gates",true);
xmlhttp.send();
</pre>
</div>
<div>
<h2>POST 请求</h2>
<p>如果需要像 HTML 表单那样 POST 数据，请使用 setRequestHeader() 来添加 HTTP 头。然后在 send() 方法中规定您希望发送的数据：</p>
<pre>xmlhttp.open("POST","ajax_test.asp",true);
xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
xmlhttp.send("fname=Bill&amp;lname=Gates");
</pre>
<table><tbody>
<tr><th>方法</th><th>描述</th></tr>
<tr><td>setRequestHeader(<i>header</i>,<i>value</i>)</td><td>
	<p>向请求添加 HTTP 头。</p>
	<ul><li><i>header</i>: 规定头的名称</li><li><i>value</i>: 规定头的值</li></ul></td></tr>
</tbody></table>
</div>

<div>
<h2>url - 服务器上的文件</h2>
<p>open() 方法的 <i>url</i> 参数是服务器上文件的地址。</p>
<p>该文件可以是任何类型的文件，比如 .txt 和 .xml，或者服务器脚本文件，如 .asp 和 .php（在传回响应之前，能够在服务器上执行任务）。</p>
</div>
<div>
<h2>异步 - true 或 false？</h2>
<p>XMLHttpRequest 对象如果要用于 AJAX 的话，其 open() 方法的 async 参数必须设置为 true：</p>
<pre>xmlhttp.open("GET","ajax_test.asp",<code>true</code>);</pre>
<p>对于 web 开发人员来说，发送异步请求是一个巨大的进步。很多在服务器执行的任务都相当费时。AJAX 出现之前，这可能会引起应用程序挂起或停止。</p>
<p>通过 AJAX，JavaScript 无需等待服务器的响应，而是：</p>
<ul>
<li>在等待服务器响应时执行其他脚本</li>
<li>当响应就绪后对响应进行处理</li>
</ul>

<h3>Async = true</h3>
<p>当使用 async=true 时，请规定在响应处于 onreadystatechange 事件中的就绪状态时执行的函数：</p>
<pre><code>xmlhttp.onreadystatechange</code>=function() {
  if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200) {
    document.getElementById("myDiv").innerHTML=xmlhttp.responseText;
  }
}
xmlhttp.open("GET","test1.txt",true);
xmlhttp.send();
</pre>

<h3>Async = false</h3>
<p>我们不推荐使用 async=false，但是对于一些小型的请求，也是可以的。</p>
<p>请记住，JavaScript 会等到服务器响应就绪才继续执行。如果服务器繁忙或缓慢，应用程序会挂起或停止。</p>
<p class="note"><span>注释：</span>当您使用 async=false 时，请不要编写 onreadystatechange 函数 - 把代码放到 send() 语句后面即可：</p>
<pre>xmlhttp.open("GET","test1.txt",false);
xmlhttp.send();
document.getElementById("myDiv").innerHTML=xmlhttp.responseText;
</pre>
</div>

<h1>AJAX - 服务器响应</h1>

<div>
<h2>服务器响应</h2>
<p>如需获得来自服务器的响应，请使用 XMLHttpRequest 对象的 responseText 或 responseXML 属性。</p>
<table>
<tbody><tr><th>属性</th><th>描述</th></tr>
<tr><td>responseText</td><td>获得字符串形式的响应数据。</td></tr>
<tr><td>responseXML</td><td>获得 XML 形式的响应数据。</td></tr>
</tbody></table>

<h3>responseText 属性</h3>
<p>如果来自服务器的响应并非 XML，请使用 responseText 属性。</p>
<p>responseText 属性返回字符串形式的响应，因此您可以这样使用：</p>
<pre>document.getElementById("myDiv").innerHTML=xmlhttp.responseText;</pre>

<h3>responseXML 属性</h3>
<p>如果来自服务器的响应是 XML，而且需要作为 XML 对象进行解析，请使用 responseXML 属性：</p>
<p>请求 <a href="/example/xmle/books.xml">books.xml</a> 文件，并解析响应：</p>
<pre>xmlDoc=xmlhttp.responseXML;
txt="";
x=xmlDoc.getElementsByTagName("ARTIST");
for (i=0;i&lt;x.length;i++) {
  txt=txt + x[i].childNodes[0].nodeValue + "&lt;br /&gt;";
}
document.getElementById("myDiv").innerHTML=txt;
</pre>
</div>

<h1>AJAX - onreadystatechange 事件</h1>

<div>
<h2>onreadystatechange 事件</h2>
<p>当请求被发送到服务器时，我们需要执行一些基于响应的任务。</p>
<p>每当 readyState 改变时，就会触发 onreadystatechange 事件。</p>
<p>readyState 属性存有 XMLHttpRequest 的状态信息。</p>
<p>下面是 XMLHttpRequest 对象的三个重要的属性：</p>
<table><tbody>
<tr><th>属性</th><th>描述</th></tr>
<tr><td>onreadystatechange</td><td>存储函数（或函数名），每当 readyState 属性改变时，就会调用该函数。</td></tr>
<tr><td>readyState</td><td><p>存有 XMLHttpRequest 的状态。从 0 到 4 发生变化。</p>
	<ul>
	<li>0: 请求未初始化</li>
	<li>1: 服务器连接已建立</li>
	<li>2: 请求已接收</li>
	<li>3: 请求处理中</li>
	<li>4: 请求已完成，且响应已就绪</li>
	</ul></td></tr>
<tr><td>status</td><td><p>200: "OK"</p><p>404: 未找到页面</p></td></tr>
</tbody></table>
<p>在 onreadystatechange 事件中，我们规定当服务器响应已做好被处理的准备时所执行的任务。</p>
<p>当 readyState 等于 4 且状态为 200 时，表示响应已就绪：</p>
<pre>xmlhttp.onreadystatechange=function()  {
  if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200) {
    document.getElementById("myDiv").innerHTML=xmlhttp.responseText;
  }
}
</pre>
<p class="note"><span>注释：</span>onreadystatechange 事件被触发 5 次（0 - 4），对应着 readyState 的每个变化。</p>
</div>

<div>
<h2>使用 callback 函数</h2>
<p>callback 函数是一种以参数形式传递给另一个函数的函数。</p>
<p>如果您的网站上存在多个 AJAX 任务，那么您应该为创建 XMLHttpRequest 对象编写一个<em>标准</em>的函数，并为每个 AJAX 任务调用该函数。</p>
<p>该函数调用应该包含 URL 以及发生 onreadystatechange 事件时执行的任务（每次调用可能不尽相同）：</p>
<pre>function myFunction() {
  loadXMLDoc("ajax_info.txt",function() {
    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200) {
      document.getElementById("myDiv").innerHTML=xmlhttp.responseText;
    }
  });
}
</pre>
<p class="tiy"><a target="_blank" href="/tiy/t.asp?f=ajax_callback">亲自试一试</a></p>
</div>

<h1>AJAX ASP/PHP 请求实例</h1>

<div>
<h2>AJAX ASP/PHP 实例</h2>
<p>下面的例子将为您演示当用户在输入框中键入字符时，网页如何与 web 服务器进行通信：</p>
<form action="" style="margin-top:15px;"> 
姓氏：<input id="txt1" onkeyup="showHint(this.value)" type="text"> 请在输入框中键入字母（A - Z）
</form>
<p>建议：<span id="txtHint">(这个位置会出现实时提示，内容来源于gethint.php输出)</span></p>
<p><a href="http://www.w3school.com.cn/tiy/t.asp?f=ajax_suggest">点击查看示例演示</a></p>
</div>

<div>
<h2>实例解释 - showHint() 函数</h2>
<p>当用户在上面的输入框中键入字符时，会执行函数 "showHint()" 。该函数由 "onkeyup" 事件触发：</p>
<pre>
function showHint(str) {
var xmlhttp;
if (str.length==0) {
  document.getElementById("txtHint").innerHTML="";
  return;
}
if (window.XMLHttpRequest)  {
  xmlhttp=new <code>XMLHttpRequest()</code>;  <span>// code for IE7+, Firefox, Chrome, Opera, Safari</span>
} else {
  xmlhttp=new <code>ActiveXObject("Microsoft.XMLHTTP")</code>;  <span>// code for IE6, IE5</span>
}
xmlhttp.<code>onreadystatechange</code>=function() {
  if (xmlhttp.<code>readyState==4</code> &amp;&amp; xmlhttp.<code>status==200</code>) {
    document.getElementById("txtHint").innerHTML=xmlhttp.<code>responseText</code>;
  }
}
xmlhttp.<code>open</code>("GET","gethint.php?q="+str,true);
xmlhttp.<code>send</code>();
}
</pre>
<h3>源代码解释：</h3>
<p>如果输入框为空 (str.length==0)，则该函数清空 txtHint 占位符的内容，并退出函数。</p>
<p>如果输入框不为空，showHint() 函数执行以下任务：</p>
<ul>
<li>创建 XMLHttpRequest 对象</li>
<li>当服务器响应就绪时执行函数</li>
<li>把请求发送到服务器上的文件</li>
<li>请注意我们向 URL 添加了一个参数 q （带有输入框的内容）</li>
</ul>
</div>
<div>
<h2>AJAX 服务器页面 - ASP 和 PHP</h2>
<p>由上面的 JavaScript 调用的服务器页面是 PHP 文件，名为 "gethint.php"。</p>

<pre>&lt;?php
<span>// 用名字来填充数组</span>
$a[]="Anna";
$a[]="Brittany";
$a[]="Cinderella";
$a[]="Ellen";
$a[]="Wenche";
$a[]="Vicky";
<span>//获得来自 URL 的 q 参数</span>
$q=$_GET["q"];
<span>//如果 q 大于 0，则查找数组中的所有提示</span>
if (strlen($q) &gt; 0) {
  $hint="";
  for($i=0; $i&lt;count($a); $i++) {
    if (strtolower($q)==strtolower(substr($a[$i],0,strlen($q)))) {
      if ($hint=="") $hint=$a[$i];
      else $hint=$hint." , ".$a[$i];
    }
  }
}
if ($hint == "") $response="no suggestion";  <span>//未找到提示则设置输出为 "no suggestion"</span>
else $response=$hint;  <span>// 否则设置为正确的值</span>
echo $response;  <span>//输出响应</span>
?&gt;
</pre>
</div>

<h1>AJAX 数据库实例</h1>

<div>
<h2>AJAX 数据库实例</h2>
<p>下面的例子将演示网页如何通过 AJAX 从数据库读取信息：</p>
<form action="" style="margin-top:15px;"> 
<label>请选择一位客户：
<select name="customers" onchange="showCustomer(this.value)" style="font-family:Verdana, Arial, Helvetica, sans-serif;">
<option value="APPLE">Apple Computer, Inc.</option>
<option value="BAIDU ">BAIDU, Inc</option>
<option value="Canon">Canon USA, Inc.</option>
<option value="Google">Google, Inc.</option>
<option value="Nokia">Nokia Corporation</option>
<option value="SONY">Sony Corporation of America</option>
</select>
</label> 请在左边的下拉列表中选择一个客户
</form>
<div id="tableHint" style="margin:15px 0 0 0;padding:0;border:0;color:#0479A7; font-weight:bold;">客户信息将在此处列出。</div>
<p class="tiy"><a target="_blank" href="http://www.w3school.com.cn/tiy/t.asp?f=ajax_database">亲自试一下源代码</a></p>
</div>

<div>
<h3>表单内容</h3>
<pre>
&lt;form action=""&gt; 
  &lt;label&gt;请选择一位客户：
    &lt;select name="customers" onchange="showCustomer(this.value)"&gt;
      &lt;option value="APPLE"&gt;Apple Computer, Inc.&lt;/option&gt;
      ......
    &lt;/select&gt;
  &lt;/label&gt; 
&lt;/form&gt;
</pre>

<h3>脚本内容</h3>
<pre>
function showCustomer(str) {
  var xmlhttp;
  if (str=="") {
    document.getElementById("txtHint").innerHTML="";
    return;
  }
  if (window.XMLHttpRequest) xmlhttp=new XMLHttpRequest();
  else xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  xmlhttp.onreadystatechange=function() {
    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200) {
      document.getElementById("tableHint").innerHTML=xmlhttp.responseText;
    }
  }
  xmlhttp.open("GET","getcustomer.php?q="+str,true);
  xmlhttp.send();
}
</pre>

<h3>服务器页面</h3>
<pre>&lt;?php
$q=$_GET["q"];
$con = mysql_connect('localhost', 'peter', 'abc123');
if (!$con) die('Could not connect: ' . mysql_error());
mysql_select_db("ajax_demo", $con);
$sql="SELECT * FROM user WHERE id = '".$q."'";
$result = mysql_query($sql);

echo "&lt;table border='1'&gt;\n
&lt;tr&gt;&lt;th&gt;Firstname&lt;/th&gt;&lt;th&gt;Lastname&lt;/th&gt;&lt;th&gt;Age&lt;/th&gt;&lt;th&gt;Hometown&lt;/th&gt;&lt;th&gt;Job&lt;/th&gt;&lt;/tr&gt;";

while($row = mysql_fetch_array($result)) {
 echo "&lt;tr&gt;";
 echo "&lt;td&gt;" . $row['FirstName'] . "&lt;/td&gt;";
 echo "&lt;td&gt;" . $row['LastName'] . "&lt;/td&gt;";
 echo "&lt;td&gt;" . $row['Age'] . "&lt;/td&gt;";
 echo "&lt;td&gt;" . $row['Hometown'] . "&lt;/td&gt;";
 echo "&lt;td&gt;" . $row['Job'] . "&lt;/td&gt;";
 echo "&lt;/tr&gt;";
}
echo "&lt;/table&gt;";
mysql_close($con);
?&gt;
</pre>
</div>

<h1>AJAX XML 实例</h1>

<div>
<p>下面的例子将演示网页如何使用 AJAX 来读取来自 XML 文件的信息：</p>
<div id="txtCDInfo">
<button onclick="loadXMLDoc('/example/xmle/cd_catalog.xml')">获得 CD 信息</button>
</div>
<p class="tiy"><a target="_blank" href="/tiy/t.asp?f=ajax_xml">亲自试一下源代码</a></p>
</div>
<div>
<h2>实例解释 - loadXMLDoc() 函数</h2>
<p>当用户点击上面的“获得 CD 信息”这个按钮，就会执行 loadXMLDoc() 函数。</p>
<p>loadXMLDoc() 函数创建 XMLHttpRequest 对象，添加当服务器响应就绪时执行的函数，并将请求发送到服务器。</p>
<p>当服务器响应就绪时，会构建一个 HTML 表格，从 XML 文件中提取节点（元素），最后使用已经填充了 XML 数据的 HTML 表格来更新 txtCDInfo 占位符：</p>
<pre>function loadXMLDoc(url)
{
var xmlhttp;
var txt,xx,x,i;
if (window.XMLHttpRequest)
  {<span>// code for IE7+, Firefox, Chrome, Opera, Safari</span>
  xmlhttp=new XMLHttpRequest();
  }
else
  {<span>// code for IE6, IE5</span>
  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
xmlhttp.onreadystatechange=function()
  {
  if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)
    {
    txt="&lt;table border='1'&gt;&lt;tr&gt;&lt;th&gt;Title&lt;/th&gt;&lt;th&gt;Artist&lt;/th&gt;&lt;/tr&gt;";
    x=xmlhttp.responseXML.documentElement.getElementsByTagName("CD");
    for (i=0;i&lt;x.length;i++)
      {
      txt=txt + "&lt;tr&gt;";
      xx=x[i].getElementsByTagName("TITLE");
        {
        try
          {
          txt=txt + "&lt;td&gt;" + xx[0].firstChild.nodeValue + "&lt;/td&gt;";
          }
        catch (er)
          {
          txt=txt + "&lt;td&gt;&nbsp;&lt;/td&gt;";
          }
        }
    xx=x[i].getElementsByTagName("ARTIST");
      {
        try
          {
          txt=txt + "&lt;td&gt;" + xx[0].firstChild.nodeValue + "&lt;/td&gt;";
          }
        catch (er)
          {
          txt=txt + "&lt;td&gt;&nbsp;&lt;/td&gt;";
          }
        }
      txt=txt + "&lt;/tr&gt;";
      }
    txt=txt + "&lt;/table&gt;";
    document.getElementById('txtCDInfo').innerHTML=txt;
    }
  }
xmlhttp.open("GET",url,true);
xmlhttp.send();
}
</pre>
</div>
<div>
<h2>AJAX 服务器页面</h2>
<p>上面这个例子中使用的服务器页面实际上是一个 XML 文件，名为 "<a href="/example/xmle/cd_catalog.xml">cd_catalog.xml</a>"。</p>
</div>

<h1>ajax处理跨域的三大方式</h1>

<div>
<h2>一、处理跨域的方式：</h2>
<p>1.代理</p>
<p>2.XHR2</p>
<p>HTML5中提供的XMLHTTPREQUEST Level2（及XHR2）已经实现了跨域访问。但ie10以下不支持。只需要在服务端填上响应头：</p>


<pre>
header("Access-Control-Allow-Origin:*");
  /*星号表示所有的域都可以接受，*/
header("Access-Control-Allow-Methods:GET,POST");
</pre>
<p>3.jsonP</p>
<p>http://www.jb51.net/article/77470.htm</p>
</div>

</div>
</body>
</html>