# SQL 进阶

MySQL Explain详解 https://www.cnblogs.com/xuanzhi201111/p/4175635.html

## SQL 规范

### 一、基础规范

1. 表存储引擎必须使用InnoDB。
2. 表字符集默认使用utf8，必要时候使用utf8mb4(emoji表情时)。
3. 禁止使用存储过程，视图，触发器，Event。
4. 禁止在数据库中存储大文件(二进制及大文本)。
5. 禁止在线上环境做数据库压力测试。
6. 测试，开发，线上数据库环境必须隔离。

### 二、命名规范

原则：命名应该有意义，简短。

1. **数据库名**：必须用小写，采用下划线分隔。
2. **表名**：全部小小，以下划线分隔，如`user_info`，表名应该为单数形式。
3. **列名**：采用驼峰命名，如`userName`。
4. 库备份必须以bak为前缀，以日期为后缀。

## 三、设计规范

1. 所有表必须有注释，描述该表作用。
2. 除通用列外的其它列必须有注释，描述该列作用。
    * 如`id`,`updateTime`,`createTime`这咱没有特殊意义时，可以不用加注释。
    * 需要为当作枚举使用的列注释其所有可能出现值的意义。如tinyint(1): 0为a,1为b,2为c。

#### 表设计规范

1. 表必须有主键，数字主键的统一使用长整型，在mysql里面为`bigint`,长度为`20`，字段名称建议取为id。
2. 禁止使用外键，通过业务层来进行关联。
3. 建议将大字段，访问频度低的字段拆分到单独的表中存储，分离冷热数据。
4. 适当数据冗余，减少表关联查询。
5. 控制单表数量，合理分表，建议超过1000W的表进行拆分。

#### 列设计规范

1. 根据业务区分使用tinyint/int/bigint，分别会占用1/4/8字节。
2. 根据业务区分使用char/varchar。
3. 所有字段定义不允许为`NULL`，业务非必填字段请设默认值。
4. 使用TINYINT来代替ENUM。
5.  建议在表中都存在以下字段：
    * `create_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT`
    * `update_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT`

#### 索引规范

1. 唯一索引使用uniq_表名_[字段名]来命名。
2. 非唯一索引使用idx_表名_[字段名]来命名。
3. 单张表索引数量建议控制在5个以内。
4. 组合索引字段数不建议超过5个。
5. 不建议在频繁更新的字段上建立索引。
6. 建索引的列必须保证其离散值。

### 四、SQL 使用规范

1. 禁止使用select *，只获取必要字段。
2. 禁止在where条件列使用函数或者表达式：减少数据库的计算，把需要计算的内容尽可能计算好当参数传入。
3. 禁止全表扫描，除明确知道表数据量非常小，并且后续不会线性增加。
4. 正常表关联查询不允许超过三张。
5. 禁止负向查询以及左模糊匹配查询。禁止进行大数据量模糊匹配。
6. OR改写为`IN()`，或者`UNION`
7. 使用批量操作代替多个单条操作(批量insert，批量查询)。
8. 分页操作时，必须保证其limit的高效，能够迅速定位到起始页。
9. 所写的SQL，必须了解其执行计划，明确该SQL的有效执行。
10. 线上禁止在业务繁忙的时间进行大批量数据更新。


## 其他

如何书写优雅漂亮的 SQL 脚本  https://www.cnblogs.com/kerrycode/archive/2010/08/16/1800334.html
