# 读写分离

注：DDD 中有个 CQRS (Command Query Responsibility Segregation) 的概念

> 中等规模业务场景的解决方案

https://cloud.tencent.com/developer/article/1664449


随着业务的发展，初期部署的一个数据库会出现IO大量增加，使得请求变慢甚至会卡死整个数据库。此时，我们一般会将读请求和写请求分开处理，即采用主从读写分离的方式。


### 读写分离架构

一般生产环境挂三个从库，最多不能超过5个，要是还不能满足需要换方案，如 多级缓存 等。

### 主从延时

主从同步是有延时的，这个延时一般在 ms 级别。

主从延迟优化

1，我们可以在这些立马需要查的业务，让它直接查主数据库，但是这种方案不推荐，因为量大怕会拖垮主数据。

2，当从数据库读取不到，我们回去再读主数据，这样就能读到数据了。但是，这种也是有风险的，量大也会拖垮主库。

3，像我前面文章提到过，分重要性业务和非重要业务，将很核心的几个业务查主数据，其他非核心，读写分离。

4，使用缓存，将新增的数据同时添加一份缓存，然后查缓存数据，这种建议新增的数据使用缓存较好。

5，使用消息队列中间件进行消息冗余，将新的主数据内容，通过消息中间件MQ冗余一份当前数据，然后发到需要查询的系统。

在消息体不大情况下，推荐使用第5种优化方案，需要消息中间件；其次考虑缓存的，因为更新的操作，需要更新缓存，也需要解决一致性问题，所以，新增的数据，就首选缓存优化方案。最后，推荐重要性非重要性隔离方案。最好不要使用都查询主库的操作。

### 客户端接入

单库的时候，我们只需要配置一个数据源就可以了，但现在有多个数据源，就需要解决请求分发的问题。

* 代码嵌入：是指在我们的代码中添加数据库访问中间层，由这个中间层去访问不同的数据源，如 淘宝开源的 TDDL
* 部署独立代理层：开源中间件有阿里的 MyCat、360的Atlas、美团的DBProxy等，都使用标准的MySql通信协议


